const { ActionRowBuilder, ButtonBuilder, ButtonStyle } = require("discord.js");
const fs = require("fs");
const { pendingChallenges, pendingResults } = require("../state/pending");

const ELO_FILE = "elo.json";
const MATCH_FILE = "matches.json";
const WYNIKI_CHANNEL_ID = "1418222553524211752";

// Wczytaj dane
let elo = fs.existsSync(ELO_FILE) ? JSON.parse(fs.readFileSync(ELO_FILE)) : {};
let matches = fs.existsSync(MATCH_FILE)
  ? JSON.parse(fs.readFileSync(MATCH_FILE))
  : [];

// Funkcja ELO
function updateElo(playerA, playerB, scoreA, scoreB) {
  const K = 30;
  if (!elo[playerA]) elo[playerA] = 1000;
  if (!elo[playerB]) elo[playerB] = 1000;
  const expectedA = 1 / (1 + Math.pow(10, (elo[playerB] - elo[playerA]) / 400));
  const resultA = scoreA > scoreB ? 1 : scoreA === scoreB ? 0.5 : 0;
  const resultB = 1 - resultA;
  const oldA = elo[playerA];
  const oldB = elo[playerB];
  elo[playerA] = Math.round(elo[playerA] + K * (resultA - expectedA));
  elo[playerB] = Math.round(elo[playerB] + K * (resultB - expectedB));
  fs.writeFileSync(ELO_FILE, JSON.stringify(elo, null, 2));
  return { a: elo[playerA] - oldA, b: elo[playerB] - oldB };
}

module.exports = {
  name: "wynik",
  description: "Wpisz wynik meczu",
  execute: async (message, args) => {
    // Tylko DM
    if (message.guild) return;

    const pendingKey = Object.keys(pendingChallenges).find(
      (k) =>
        pendingChallenges[k].status === "accepted" &&
        k.startsWith(message.author.id)
    );
    if (!pendingKey)
      return message.channel.send(
        "‚ùå Brak aktywnych wyzwa≈Ñ do wpisania wyniku."
      );

    const match = message.content.match(/^(\d+):(\d+)$/);
    if (!match)
      return message.channel.send("‚ö†Ô∏è U≈ºyj formatu bramkiA:bramkiB np. 2:1");

    const [scoreA, scoreB] = [parseInt(match[1]), parseInt(match[2])];
    pendingResults[pendingKey] = { scoreA, scoreB };

    const playerBId = pendingKey.split("_")[1];
    const playerBUser = await message.client.users.fetch(playerBId);

    const row = new ActionRowBuilder().addComponents(
      new ButtonBuilder()
        .setCustomId(`confirm_${pendingKey}`)
        .setLabel("‚úÖ Zatwierd≈∫ wynik")
        .setStyle(ButtonStyle.Success)
    );

    await playerBUser.send({
      content: `üì¢ <@${message.author.id}> wpisa≈Ç wynik: ${scoreA}:${scoreB}. Potwierd≈∫ wynik.`,
      components: [row],
    });
    return message.channel.send(
      "‚úÖ Wynik wpisany. Czekaj na zatwierdzenie przez przeciwnika."
    );
  },
};
